---
title: "mapdamage_misincorporation"
author: "Anna Maria Calderon"
date: "2025-05-08"
output: html_document
---

# Setup

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(ggplot2)
library(readr)
library(tidyr)
library(dplyr)
library(reshape2)
library(ggpubr)
setwd("/Users/abc6435/Desktop/KROH/data/mapdamage/")

d <- read_tsv("misincorporation.txt")
```

# Modify Data

```{r modify_data, include=FALSE}
#Flip 3p x-axis
d[d[, 3] == "3p", 5] <- -1*d[d[, 3] == "3p", 5]

#Calculate Frequencies
d$fga <- d$`G>A`/d$`G`
d$fct <- d$`C>T`/d$`C`
d$fcg <- d$`C>G`/d$`C`
d$fca <- d$`C>A`/d$`C`
d$fgt <- d$`G>T`/d$`G`
d$fgc <- d$`G>C`/d$`G`


#Subset Data
misincorp <- d[,c("Sample", "Library", "End", "Std", "Pos",
                  "fga", "fct",
                  "fcg", "fca",
                  "fgt", "fgc")]

colnames(misincorp) <- c("sample", "library", "end", "std","pos",
                  "G>A", "C>T","C>G", "C>A","G>T", "G>C")
#Melt Data
misincorp_m <- melt(misincorp,
                   id.vars=c("sample","end","std", "pos","library"),
                   variable.name="mutation",
                   value.name="frequency")

misincorp_m$end<- factor(misincorp_m$end, levels = c("5p","3p"))

#Subset By Population
misincorp_m_c <- subset(misincorp_m, misincorp_m$library=="contemporary")
misincorp_m_h <- subset(misincorp_m, misincorp_m$library=="historical")
```

# Plot

```{r plot, include=FALSE}
#Contemporary
misincorp_m_c_plot <- 
  ggplot(misincorp_m_c, aes(x=pos, y=frequency, color=mutation, alpha=std)) +
  geom_line(linewidth = 1) +
  scale_y_continuous(limits=c(0,0.05)) +
  facet_grid(rows=vars(sample), cols=vars(end), scales="free_x") +
  scale_color_manual(values=
                       c("blue","red",
                         "gray","gray",
                         "gray","gray")) +
  scale_alpha_manual(values=c(0.5,1)) +
  theme(legend.position="none",
        panel.background = element_blank(),
        panel.border = element_rect(fill=NA, color="black"),
        strip.background = element_rect(fill="gray", color="gray"),
        strip.text=element_text(color="black", face="bold"),
        axis.text = element_text(size=8, color="black"),
        axis.title = element_text(size=8, color="black")) +
  xlab("Position From Fragment End") +
  ylab("Frequency")

#Historical
misincorp_m_h_plot <- 
  ggplot(misincorp_m_h, aes(x=pos, y=frequency, color=mutation, alpha=std)) +
  geom_line(linewidth = 1) +
  scale_y_continuous(limits=c(0,0.05)) +
  facet_grid(rows=vars(sample), cols=vars(end), scales="free_x") +
  scale_color_manual(values=
                       c("blue","red",
                         "gray","gray",
                         "gray","gray")) +
  scale_alpha_manual(values=c(0.5,1)) +
  theme(legend.position="none",
        panel.background = element_blank(),
        panel.border = element_rect(fill=NA, color="black"),
        strip.background = element_rect(fill="black", color="black"),
        strip.text=element_text(color="white", face="bold"),
        axis.text = element_text(size=8, color="black"),
        axis.title = element_text(size=8, color="black")) +
  xlab("Position From Fragment End") +
  ylab("Frequency")
```

```{r arrange_save, include=FALSE}

misincorp_figure <- 
  ggarrange(misincorp_m_h_plot,
            misincorp_m_c_plot,
            labels = c("A","B"),
            ncol=2,
            nrow=1)

ggsave("misincorp.png", 
       plot=misincorp_figure,
       path = "/Users/abc6435/Desktop/KROH/figures",
       width = 6,
       height = 6,
       units = "in",
       dpi = 300)

```
